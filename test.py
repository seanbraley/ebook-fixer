# -*- coding: utf-8 -*-
__author__ = 'sean.braley'

import re

from models import Book

test_paragraph = """THE fog was thick at the center of the bridge where the man stood leaning against the rail. Although the streets of New York were scarcely a hundred yards away, he might have been in a little world of his own. For the only light in the midst of that cloud of black night fog came from an arc light on the bridge. A taxicab, carrying a late passenger home, shot through the mist. The man stepped away from the rail and crouched beside a post. He saw a flash of the red tail light on the cab; a moment later it was lost in the fog. As the noise of the motor died away, the man stood up again and placed his hands upon the rail. He listened, afraid that another cab might be coming across the bridge; then, reassured, he leaned over the rail and stared downward. Mist; thick, black mist - nothing but mist. It seemed to invite his plunge. Yet he hesitated - as many wait when they are upon the brink of death - until, with a mad impulse, he swung his body across the rail and loosened his hands. Something clamped upon his shoulder. An iron grip held him - balanced between life and death. Then, as though his body possessed no weight whatever, the man felt himself pulled around in a sweeping circle. He staggered as his feet struck the sidewalk of the bridge. He turned to confront the person who had interfered. He swung his fist angrily, but a hand caught his wrist and twisted it behind his back with irresistible power. It was as though the man's strength had been wrested from him when he faced a tall, black-cloaked figure that might have represented death itself. For he could not have sworn that he was looking at a human being. The stranger's face was entirely obscured by a broad-brimmed felt hat bent downward over his features; and the long, black cloak looked like part of the thickening fog. The man who had attempted suicide was too startled to speak. Fear had come upon him, and his only desire was to shrink from this grim and eerie master of the night. But he felt himself pulled across the sidewalk, and at the curb he stumbled through the open door of a large limousine, which he had not seen until that moment. His arm was freed, and he shrank into the far corner of the car. The door closed and the car moved onward. Fear still clutched the man whose life had been saved against his will. Rescued, he sensed that the grim stranger was in the seat beside him. He expected new evidence of that weird personage's presence. The evidence came. A voice spoke through the darkness. It was a weird, chilling voice - scarcely more than a whisper, yet clear and penetrating. "What is your name?" It was not a question. Rather, it was a command to speak. "Harry Vincent," replied the man who had been deterred from self-destruction. The words had come to his lips automatically. "Why did you try suicide?" It was another command. "Melancholy," said Vincent. He was speaking of his own accord now; somehow he wanted to talk. "Go on," came the voice. "It's not much of a story," replied Vincent. "Perhaps I was a fool. I'm all alone here in New York. No job, no friends, nothing to live for. My folks are all out in the Middle West, and I haven't seen them for years. I don't want to see them. I guess they think I'm a success here, but I'm not." "You are well dressed," the stranger's voice remarked. Vincent laughed nervously. "Yes," he said, "I'm wearing a light overcoat, and the weather hasn't scarcely begun to be chilly. But that's only appearance. Everything else is in hock. I have one dollar and thirteen cents in actual cash." The mysterious stranger did not reply. The car was rolling along a side street; the bridge was now far behind. Vincent, his nerves somewhat settled, stared into the opposite corner of the limousine, vainly seeking to observe his companion's face. But the shade was drawn and he could not even detect a blotch amid the darkness. "What about the girl?" came the voice. The penetrating whisper startled Vincent. The single, and most important, item that he had omitted from his brief story had been fathomed by this stranger whose cunning was the equal of his strength. "The girl?" questioned Vincent. "The girl? My - my girl out home?" "Yes." "She married another man," said Vincent. "That was the reason I was on the bridge to-night. I might have struggled on for a while if I hadn't been so hard up. But when the letter came that told me she was married - Well, that ended it." He paused, and hearing no reply, added to his confession: "The letter came two days ago," he said. "I haven't slept since. I was on the bridge all last night, but I didn't have nerve to jump - then. I guess it was the fog that helped me this time." "Your life," said the stranger's voice slowly, "is no longer your own. It belongs to me now. But you are still free to destroy it. Shall we return to the bridge?" "I don't know," blurted Vincent. "This is all like a dream; I don't understand it. Perhaps I did fall from the bridge, and this is death that I am now experiencing. Yet it seems real, after all. What good is my life to any one? What will you do with it?" "I shall improve it," replied the voice from the darkness. "I shall make it useful. But I shall risk it, too. Perhaps I shall lose it, for I have lost lives, just as I have saved them. This is my promise: life, with enjoyment, with danger, with excitement, and - with money. Life, above all, with honor. If I give it, I demand obedience. Absolute obedience. You may accept my terms, or you may refuse. I shall wait for you to choose." The car rolled on comfortably through the side streets of upper New York. The motor seemed noiseless; Harry Vincent began to understand how it had approached him unheard upon the bridge. He was wondering about his strange companion; this being who had whirled him away from his fatal plunge as though his hundred and seventy pounds had been nothing; this personage who could read his thoughts and whose questions were commands. Harry turned again toward the darkened corner, and hope returned to him. After all, he wanted life. He had come to New York because he had desired to live and to succeed. This was his opportunity. He pictured his lifeless body, beneath the bridge, and he realized that he could make but one choice. "I accept," he said. "Remember then, obedience," said the voice. "That must come always. I do not ask for cleverness, for strength or skill, although I want them, and will expect them to the best of your ability." There was a pause. The whispered voice seemed to echo in Vincent's ears. He realized that there was neither approval nor surprise in the stranger's words. Simply calmness. "You will be taken immediately to a hotel," resumed the voice. "You will find a room reserved in your name. There will be money there. Your requirements will be filled. You will obtain everything you want. Your bills will be paid." The point of a cane swung from the rear seat and tapped twice against the windowpane behind the chauffeur. It seemed to be a signal, for the speed of the car increased as it sharply swung a corner. "But, remember, Harry Vincent," said the voice from the corner, "I must have your promise. Shut your eyes for one full minute while you think on it. Then promise, if you wish. Promise your obedience." Vincent closed his eyes and thought. His mind cleared and life seemed to brighten. There was but one course; that was acceptance of the stranger's terms. He opened his eyes and again gazed at that blackened corner. "I promise," he said. "I promise full obedience." "Very well," came the stranger's whisper. "Go to your hotel. To-morrow you will receive a message. It will come from me; and my messages are meaningless to those who should not understand them. Listen well when you receive it. Remember only the words which are emphasized in pronouncing like this." There was a stressing of the last word. It seemed almost a sentence in itself and the hiss of the stranger's whisper carried a weird, unearthly sound. The car swerved suddenly and stopped with a jolt against the curb on the left. An open car had forced it to the sidewalk; and the headlights of the other automobile were glaring through the window. A figure opened the door on the right and Vincent saw a man's head and shoulders jutting up. "Stick 'em up!" came a rough voice. Vincent raised his hands as he saw the glint of a revolver barrel. It was a holdup - a daring crime on this side street of Manhattan! Then something emerged from the darkened corner of the limousine. It spread like a huge monster of the night, a black shape that swept forward and enveloped the gangster in its folds. There was a muffled cry, then a pistol shot, and the car suddenly darted forward. The door closed with a crash. Through the rear window of the limousine, Vincent saw a man sprawled in the street. Evidently it was the fellow who had attempted the holdup. Then the car burst into the glare of the lights on Fifth Avenue. Vincent turned quickly to the corner where his strange companion sat. Now he would see his mysterious companion face to face! But, except for himself, the car was empty. He was alone in the limousine. A dark splotch showed on the inside of the door; he touched it and found blood on his hand. Who had been wounded - the shadowy stranger or the assailant who had tried to enter the limousine? Vincent could not guess; he only knew that in the brief struggle the man who had found him on the bridge had left the automobile - unseen and unheard - and the door had closed behind him. The mysterious stranger had vanished - like a shadow!"""

theShadowBook = Book('The Shadow', 'Walter B. Gibson', 'Mystery;Adventure', test_paragraph)
theShadowBook.estimate_pulpiness_fuzzy()
print theShadowBook.pulp_value
# Match sets of quotations
# http://stackoverflow.com/questions/9519734/python-regex-to-find-a-string-in-double-quotes-within-a-string
sentence = r'(.+?)(\.\s|\!\s|\?\s|\.\"\s|\?\"\s)'
# '. ' OR '."' OR '? ' OR '! '
speaking = r'\"(.+?)\"'
charchange1 = r'(A )'
charchange2 = r'(The )'

sentences = re.findall(sentence, test_paragraph)

unbroken = 0
for sen in sentences:
    rating = 0.0
    if re.match(speaking, sen[0]):
        rating += .5
    if re.match(charchange1, sen[0]):
        rating += .5
    if re.match(charchange2, sen[0]):
        rating = 1.0

    if rating < 1.0:
        unbroken += 1
    else:
        unbroken = 0

    if len(sen[0]) < 30:
        rating += .5

    if unbroken >= 5:
        unbroken = 0
        rating = 1.0

    # print "Rating: %0.1f" % rating, sen[0] + sen[1]

